generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id           String               @id @default(uuid())
  slug         String               @unique
  name         String
  logoUrl      String?              @map("logo_url")
  settings     Json?                @map("settings_json")
  createdAt    DateTime             @default(now()) @map("created_at")
  platformName String?              @map("platform_name")
  aiSessions   AIChatSession[]
  assignments  Assignment[]
  courses      Course[]
  enrollments  Enrollment[]
  files        File[]
  groups       Group[]
  memberships  Membership[]
  domains      OrganizationDomain[]
  progress     ProgressEvent[]
}

model OrganizationDomain {
  id         String       @id @default(uuid())
  orgId      String       @map("org_id")
  domain     String       @unique
  verifiedAt DateTime?    @map("verified_at")
  org        Organization @relation(fields: [orgId], references: [id])
}

model User {
  id                String             @id @default(uuid())
  email             String             @unique
  name              String
  avatarUrl         String?            @map("avatar_url")
  createdAt         DateTime           @default(now()) @map("created_at")
  lastActiveAt      DateTime?          @map("last_active_at")
  passwordHash      String?            @map("password_hash")
  isSuperAdmin      Boolean            @default(false) @map("is_super_admin")
  aiSessions        AIChatSession[]
  createdCourses    Course[]           @relation("CourseCreatedBy")
  courseInstructors CourseInstructor[]
  enrollments       Enrollment[]
  files             File[]             @relation("UploadedFiles")
  graded            Grade[]            @relation("GradedBy")
  groupMemberships  GroupMember[]
  assignedGroups    Group[]            @relation("AssignedTeacher")
  memberships       Membership[]
  progressEvents    ProgressEvent[]
  submissions       Submission[]
}

model Membership {
  id     String           @id @default(uuid())
  orgId  String           @map("org_id")
  userId String           @map("user_id")
  role   Role
  status MembershipStatus @default(active)
  org    Organization     @relation(fields: [orgId], references: [id])
  user   User             @relation(fields: [userId], references: [id])

  @@unique([orgId, userId])
}

model Course {
  id             String             @id @default(uuid())
  orgId          String             @map("org_id")
  title          String
  description    String?
  thumbnailUrl   String?            @map("thumbnail_url")
  status         CourseStatus       @default(draft)
  createdById    String             @map("created_by")
  createdAt      DateTime           @default(now()) @map("created_at")
  aiSessions     AIChatSession[]
  assignments    Assignment[]
  createdBy      User               @relation("CourseCreatedBy", fields: [createdById], references: [id])
  org            Organization       @relation(fields: [orgId], references: [id])
  instructors    CourseInstructor[]
  sections       CourseSection[]
  enrollments    Enrollment[]
  groups         Group[]
  progressEvents ProgressEvent[]
}

model CourseInstructor {
  id       String @id @default(uuid())
  courseId String @map("course_id")
  userId   String @map("user_id")
  course   Course @relation(fields: [courseId], references: [id])
  user     User   @relation(fields: [userId], references: [id])

  @@unique([courseId, userId])
}

model CourseSection {
  id       String   @id @default(uuid())
  courseId String   @map("course_id")
  title    String
  position Int
  course   Course   @relation(fields: [courseId], references: [id])
  lessons  Lesson[]
}

model Lesson {
  id             String          @id @default(uuid())
  sectionId      String          @map("section_id")
  title          String
  content        Json?           @map("content_richtext")
  videoUrl       String?         @map("video_url")
  position       Int
  duration       Int?            @map("duration_minutes")
  aiSessions     AIChatSession[]
  section        CourseSection   @relation(fields: [sectionId], references: [id])
  progressEvents ProgressEvent[]
}

model Enrollment {
  id       String           @id @default(uuid())
  orgId    String           @map("org_id")
  courseId String           @map("course_id")
  userId   String           @map("user_id")
  status   EnrollmentStatus @default(active)
  course   Course           @relation(fields: [courseId], references: [id])
  org      Organization     @relation(fields: [orgId], references: [id])
  user     User             @relation(fields: [userId], references: [id])

  @@unique([courseId, userId])
}

model Assignment {
  id          String         @id @default(uuid())
  orgId       String         @map("org_id")
  courseId    String         @map("course_id")
  title       String
  description Json?          @map("description_richtext")
  dueAt       DateTime?      @map("due_at")
  maxPoints   Int?           @map("max_points")
  type        AssignmentType
  course      Course         @relation(fields: [courseId], references: [id])
  org         Organization   @relation(fields: [orgId], references: [id])
  submissions Submission[]
}

model Submission {
  id           String     @id @default(uuid())
  assignmentId String     @map("assignment_id")
  userId       String     @map("user_id")
  submittedAt  DateTime   @default(now()) @map("submitted_at")
  content      Json?      @map("content_json")
  attachment   String?    @map("attachment_url")
  grade        Grade?
  assignment   Assignment @relation(fields: [assignmentId], references: [id])
  user         User       @relation(fields: [userId], references: [id])
}

model Grade {
  id           String     @id @default(uuid())
  submissionId String     @unique @map("submission_id")
  gradedById   String     @map("graded_by")
  score        Int
  feedback     Json?      @map("feedback_richtext")
  gradedAt     DateTime   @default(now()) @map("graded_at")
  gradedBy     User       @relation("GradedBy", fields: [gradedById], references: [id])
  submission   Submission @relation(fields: [submissionId], references: [id])
}

model Group {
  id                String        @id @default(uuid())
  orgId             String        @map("org_id")
  courseId          String?       @map("course_id")
  assignedTeacherId String?       @map("assigned_teacher_id")
  name              String
  description       String?
  course            Course?       @relation(fields: [courseId], references: [id])
  org               Organization  @relation(fields: [orgId], references: [id])
  assignedTeacher   User?         @relation("AssignedTeacher", fields: [assignedTeacherId], references: [id])
  members           GroupMember[]
}

model GroupMember {
  id      String @id @default(uuid())
  groupId String @map("group_id")
  userId  String @map("user_id")
  group   Group  @relation(fields: [groupId], references: [id])
  user    User   @relation(fields: [userId], references: [id])

  @@unique([groupId, userId])
}

model ProgressEvent {
  id         String            @id @default(uuid())
  orgId      String            @map("org_id")
  userId     String            @map("user_id")
  courseId   String?           @map("course_id")
  lessonId   String?           @map("lesson_id")
  type       ProgressEventType
  metadata   Json?             @map("metadata_json")
  occurredAt DateTime          @default(now()) @map("occurred_at")
  course     Course?           @relation(fields: [courseId], references: [id])
  lesson     Lesson?           @relation(fields: [lessonId], references: [id])
  org        Organization      @relation(fields: [orgId], references: [id])
  user       User              @relation(fields: [userId], references: [id])
}

model AIChatSession {
  id        String       @id @default(uuid())
  orgId     String       @map("org_id")
  userId    String       @map("user_id")
  courseId  String?      @map("course_id")
  lessonId  String?      @map("lesson_id")
  title     String?
  createdAt DateTime     @default(now()) @map("created_at")
  course    Course?      @relation(fields: [courseId], references: [id])
  lesson    Lesson?      @relation(fields: [lessonId], references: [id])
  org       Organization @relation(fields: [orgId], references: [id])
  user      User         @relation(fields: [userId], references: [id])
  messages  AIMessage[]
}

model AIMessage {
  id        String        @id @default(uuid())
  sessionId String        @map("session_id")
  sender    Sender
  content   String
  tokens    Int?
  createdAt DateTime      @default(now()) @map("created_at")
  session   AIChatSession @relation(fields: [sessionId], references: [id])
}

model File {
  id         String       @id @default(uuid())
  orgId      String       @map("org_id")
  uploaderId String       @map("uploader_id")
  url        String
  kind       FileKind
  createdAt  DateTime     @default(now()) @map("created_at")
  org        Organization @relation(fields: [orgId], references: [id])
  uploader   User         @relation("UploadedFiles", fields: [uploaderId], references: [id])
}

enum Role {
  admin
  teacher
  student
}

enum MembershipStatus {
  active
  invited
  suspended
}

enum CourseStatus {
  draft
  active
  archived
}

enum EnrollmentStatus {
  active
  completed
  dropped
}

enum AssignmentType {
  essay
  quiz
  project
}

enum ProgressEventType {
  viewed_lesson
  completed_assignment
  login
  ai_usage
}

enum Sender {
  user
  assistant
  system
}

enum FileKind {
  assignment_attachment
  submission_attachment
  lesson_asset
}
